# Operaciones con Máquinas Virtuales KVM

## Tabla de contenido

- [Operaciones con Máquinas Virtuales KVM](#operaciones-con-máquinas-virtuales-kvm)
  - [Tabla de contenido](#tabla-de-contenido)
  - [Introducción](#introducción)
  - [Desarrollo](#desarrollo)
    - [Fase 1. Copia de seguridad y restauración manual](#fase-1-copia-de-seguridad-y-restauración-manual)
      - [Tarea 1. Creación de copia de seguridad de la máquina virtual](#tarea-1-creación-de-copia-de-seguridad-de-la-máquina-virtual)
      - [Tarea 2. Creación de máquina virtual a partir de copia de seguridad](#tarea-2-creación-de-máquina-virtual-a-partir-de-copia-de-seguridad)
    - [Fase 2. Clonación de máquinas virtuales](#fase-2-clonación-de-máquinas-virtuales)
      - [Tarea 3. Clonación mediante virt-manager](#tarea-3-clonación-mediante-virt-manager)
      - [Tarea 4. Clonación mediante virt-clone](#tarea-4-clonación-mediante-virt-clone)
    - [Fase 3. Creación de máquinas virtuales con virt-install](#fase-3-creación-de-máquinas-virtuales-con-virt-install)
      - [Tarea 5. Creación e instalación de máquina virtual con virt-install](#tarea-5-creación-e-instalación-de-máquina-virtual-con-virt-install)
  - [Pruebas y Validación](#pruebas-y-validación)
    - [Verificación de máquinas virtuales clonadas](#verificación-de-máquinas-virtuales-clonadas)
    - [Verificación de conectividad](#verificación-de-conectividad)
    - [Verificación de acceso SSH](#verificación-de-acceso-ssh)
  - [Solución de Problemas Comunes](#solución-de-problemas-comunes)
    - [Problemas con la clonación de máquinas virtuales](#problemas-con-la-clonación-de-máquinas-virtuales)
    - [Problemas de conectividad](#problemas-de-conectividad)
    - [Problemas con virt-install](#problemas-con-virt-install)
  - [Conclusiones](#conclusiones)
  - [Bibliografía](#bibliografía)

## Introducción

El objetivo de esta práctica es realizar operaciones con máquinas virtuales utilizando diferentes herramientas disponibles en la plataforma de virtualización KVM. Se utilizarán tanto el entorno gráfico (`virt-manager`) como las utilidades de línea de comandos (`virsh`, `virt-clone`, `virt-install`) para gestionar dominios virtuales.

Esta práctica permite familiarizarse con diferentes métodos para copiar, clonar y crear máquinas virtuales, así como verificar su correcto funcionamiento y conectividad.

## Desarrollo

### Fase 1. Copia de seguridad y restauración manual

#### Tarea 1. Creación de copia de seguridad de la máquina virtual

En esta tarea se realizará una copia de seguridad manual de la máquina virtual mvp1 creada en la práctica anterior. Para ello, se identificarán y copiarán los archivos necesarios sin utilizar herramientas específicas de clonación.

Como paso previo, se localizan los archivos de configuración de la máquina virtual. Primero se busca el archivo de definición XML con la máquina virtual apagada:

```bash
root@lq-d25:~# find / -name 'mvp1.xml'
/etc/libvirt/qemu/mvp1.xml
```

**Explicación del comando**:

- `find`: Herramienta para buscar archivos en el sistema de archivos
- `/`: Comenzar la búsqueda desde la raíz del sistema de archivos
- `-name 'mvp1.xml'`: Buscar archivos con el nombre exacto 'mvp1.xml'

Ahora, se vuelve a ejecutar el mismo comando con la máquina virtual ejecutándose:

```bash
root@lq-d25:~# find / -name 'mvp1.xml'
/etc/libvirt/qemu/mvp1.xml
/run/libvirt/qemu/mvp1.xml
```

**Explicación de la salida**:

- Cuando la máquina virtual no está en ejecución, el archivo de definición XML solo se encuentra en `/etc/libvirt/qemu/`
- Cuando la máquina virtual está en ejecución, aparece una copia adicional en `/run/libvirt/qemu/`
- El archivo en `/etc/libvirt/qemu/` es la definición persistente de la máquina virtual
- El archivo en `/run/libvirt/qemu/` es una copia temporal utilizada durante la ejecución de la VM que puede contener información de estado adicional

A continuación, se necesita identificar dónde se encuentra la imagen del disco de la máquina virtual:

```bash
root@lq-d25:~# find / -name '*.qcow2'
/var/lib/libvirt/images/fedora.qcow2
/usr/share/edk2/ovmf/OVMF_VARS_4M.secboot.qcow2
/usr/share/edk2/ovmf/OVMF_CODE_4M.secboot.qcow2
/usr/share/edk2/ovmf/OVMF_VARS_4M.qcow2
/usr/share/edk2/ovmf/OVMF_CODE_4M.qcow2
```

La salida muestra que la máquina virtual mvp1 utiliza un archivo de imagen de disco ubicado en `/var/lib/libvirt/images/fedora.qcow2`.

Para una copia de seguridad completa, se necesita copiar tanto el archivo de definición XML como la imagen del disco. 

Primero, se crea un directorio para almacenar la copia de seguridad:

```bash
root@lq-d25:~# mkdir -p /backup/mvp1/
```

Ahora, se copian los archivos necesarios:

```bash
root@lq-d25:~# cp /etc/libvirt/qemu/mvp1.xml /backup/mvp1/
root@lq-d25:~# cp /var/lib/libvirt/images/fedora.qcow2 /backup/mvp1/fedora.qcow2
```

Se verifica que los archivos se hayan copiado correctamente:

```bash
root@lq-d25:~# ls -lh /backup/mvp1/
total 2.1G
-rw-r--r-- 1 root root 2.1G Feb 20 14:30 fedora.qcow2
-rw-r--r-- 1 root root 3.2K Feb 20 14:30 mvp1.xml
```

Con estos archivos respaldados, tenemos todo lo necesario para recrear la máquina virtual en el siguiente paso.

#### Tarea 2. Creación de máquina virtual a partir de copia de seguridad

Utilizando los archivos copiados en la tarea anterior, se creará una nueva máquina virtual llamada "clon_copiando_ficheros" mediante la herramienta virsh. La máquina resultante debe quedar completamente operativa y con conectividad de red.



### Fase 2. Clonación de máquinas virtuales

#### Tarea 3. Clonación mediante virt-manager

En esta tarea se realizará la clonación de la máquina virtual mvp1 utilizando la interfaz gráfica virt-manager. La nueva máquina virtual se llamará "clon_virt_manager" y deberá verificarse su correcto funcionamiento y conectividad.

#### Tarea 4. Clonación mediante virt-clone

En esta tarea se realizará la clonación de la máquina virtual mvp1 utilizando la herramienta de línea de comandos virt-clone. La nueva máquina virtual se llamará "clon_virt_clone" y deberá verificarse su correcto funcionamiento y conectividad.

### Fase 3. Creación de máquinas virtuales con virt-install

#### Tarea 5. Creación e instalación de máquina virtual con virt-install

En esta tarea se creará una nueva máquina virtual llamada "Creacion_virt_install" utilizando la herramienta de línea de comandos virt-install. La máquina virtual tendrá las siguientes especificaciones:

- RAM: 2 GB
- CPU: 1
- Disco: 10 GB
- Sistema Operativo: Fedora Server 41 (instalación mínima)
- Red: NAT

## Pruebas y Validación

### Verificación de máquinas virtuales clonadas

### Verificación de conectividad

### Verificación de acceso SSH

## Solución de Problemas Comunes

### Problemas con la clonación de máquinas virtuales

### Problemas de conectividad

### Problemas con virt-install

## Conclusiones

## Bibliografía

1. Herrmann J, Zimmerman Y, Parker D, Novich L, East J, Radvan S. Red Hat Enterprise Linux 7. Virtualization Getting Started Guide. Introduction to virtualization technologies available with RHEL, Red Hat; 2019. Disponible en: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/ [accedido el 02/01/2024]

2. Herrmann J, Zimmerman Y, Novich L, Parker D, Radvan S, Richardson T. Red Hat Enterprise Linux 7. Virtualization Deployment and Administration Guide. Installing, configuring, and managing virtual machines on a RHEL physical machine, Red Hat; 2019. Disponible en: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/ [accedido el 02/01/2024]

3. Documentación de Fedora sobre virtualización: [https://docs.fedoraproject.org/en-US/quick-docs/virtualization-getting-started/](https://docs.fedoraproject.org/en-US/quick-docs/virtualization-getting-started/)

4. Libvirt Wiki: [https://wiki.libvirt.org/](https://wiki.libvirt.org/)
