# Operaciones con Máquinas Virtuales KVM

## Tabla de contenido

- [Operaciones con Máquinas Virtuales KVM](#operaciones-con-máquinas-virtuales-kvm)
  - [Tabla de contenido](#tabla-de-contenido)
  - [Introducción](#introducción)
  - [Desarrollo](#desarrollo)
    - [Fase 1. Copia de seguridad y restauración manual](#fase-1-copia-de-seguridad-y-restauración-manual)
      - [Tarea 1. Creación de copia de seguridad de la máquina virtual](#tarea-1-creación-de-copia-de-seguridad-de-la-máquina-virtual)
      - [Tarea 2. Creación de máquina virtual a partir de copia de seguridad](#tarea-2-creación-de-máquina-virtual-a-partir-de-copia-de-seguridad)
    - [Fase 2. Clonación de máquinas virtuales](#fase-2-clonación-de-máquinas-virtuales)
      - [Tarea 3. Clonación mediante virt-manager](#tarea-3-clonación-mediante-virt-manager)
      - [Tarea 4. Clonación mediante virt-clone](#tarea-4-clonación-mediante-virt-clone)
    - [Fase 3. Creación de máquinas virtuales con virt-install](#fase-3-creación-de-máquinas-virtuales-con-virt-install)
      - [Tarea 5. Creación e instalación de máquina virtual con virt-install](#tarea-5-creación-e-instalación-de-máquina-virtual-con-virt-install)
  - [Pruebas y Validación](#pruebas-y-validación)
    - [Verificación de máquinas virtuales clonadas](#verificación-de-máquinas-virtuales-clonadas)
    - [Verificación de conectividad](#verificación-de-conectividad)
    - [Verificación de acceso SSH](#verificación-de-acceso-ssh)
  - [Solución de Problemas Comunes](#solución-de-problemas-comunes)
    - [Problemas con la clonación de máquinas virtuales](#problemas-con-la-clonación-de-máquinas-virtuales)
    - [Problemas de conectividad](#problemas-de-conectividad)
    - [Problemas con virt-install](#problemas-con-virt-install)
  - [Conclusiones](#conclusiones)
  - [Bibliografía](#bibliografía)

## Introducción

El objetivo de esta práctica es realizar operaciones con máquinas virtuales utilizando diferentes herramientas disponibles en la plataforma de virtualización KVM. Se utilizarán tanto el entorno gráfico (`virt-manager`) como las utilidades de línea de comandos (`virsh`, `virt-clone`, `virt-install`) para gestionar dominios virtuales.

Esta práctica permite familiarizarse con diferentes métodos para copiar, clonar y crear máquinas virtuales, así como verificar su correcto funcionamiento y conectividad.

## Desarrollo

### Fase 1. Copia de seguridad y restauración manual

#### Tarea 1. Creación de copia de seguridad de la máquina virtual

En esta tarea se realizará una copia de seguridad manual de la máquina virtual mvp1 creada en la práctica anterior. Para ello, se identificarán y copiarán los archivos necesarios sin utilizar herramientas específicas de clonación.

Como paso previo, se localizan los archivos de configuración de la máquina virtual. Primero se busca el archivo de definición XML con la máquina virtual apagada:

```bash
root@lq-d25:~# find / -name 'mvp1.xml'
/etc/libvirt/qemu/mvp1.xml
```

**Explicación del comando**:

- `find`: Herramienta para buscar archivos en el sistema de archivos
- `/`: Comenzar la búsqueda desde la raíz del sistema de archivos
- `-name 'mvp1.xml'`: Buscar archivos con el nombre exacto 'mvp1.xml'

Ahora, se vuelve a ejecutar el mismo comando con la máquina virtual ejecutándose:

```bash
root@lq-d25:~# find / -name 'mvp1.xml'
/etc/libvirt/qemu/mvp1.xml
/run/libvirt/qemu/mvp1.xml
```

**Explicación de la salida**:

- Cuando la máquina virtual no está en ejecución, el archivo de definición XML solo se encuentra en `/etc/libvirt/qemu/`
- Cuando la máquina virtual está en ejecución, aparece una copia adicional en `/run/libvirt/qemu/`
- El archivo en `/etc/libvirt/qemu/` es la definición persistente de la máquina virtual
- El archivo en `/run/libvirt/qemu/` es una copia temporal utilizada durante la ejecución de la VM que puede contener información de estado adicional

A continuación, se necesita identificar dónde se encuentra la imagen del disco de la máquina virtual:

```bash
root@lq-d25:~# find / -name '*.qcow2'
/var/lib/libvirt/images/fedora.qcow2
/usr/share/edk2/ovmf/OVMF_VARS_4M.secboot.qcow2
/usr/share/edk2/ovmf/OVMF_CODE_4M.secboot.qcow2
/usr/share/edk2/ovmf/OVMF_VARS_4M.qcow2
/usr/share/edk2/ovmf/OVMF_CODE_4M.qcow2
```

La salida muestra que la máquina virtual mvp1 utiliza un archivo de imagen de disco ubicado en `/var/lib/libvirt/images/fedora.qcow2`.

Para una copia de seguridad completa, se necesita copiar tanto el archivo de definición XML como la imagen del disco.

Primero, se crea un directorio para almacenar la copia de seguridad:

```bash
root@lq-d25:~# mkdir -p /backup/mvp1/
```

Ahora, se copian los archivos necesarios:

```bash
root@lq-d25:~# cp /etc/libvirt/qemu/mvp1.xml /backup/mvp1/
root@lq-d25:~# cp /var/lib/libvirt/images/fedora.qcow2 /backup/mvp1/fedora.qcow2
```

Se verifica que los archivos se hayan copiado correctamente:

```bash
root@lq-d25:~# ls -lh /backup/mvp1/
total 2.1G
-rw-r--r-- 1 root root 2.1G Feb 20 14:30 fedora.qcow2
-rw-r--r-- 1 root root 3.2K Feb 20 14:30 mvp1.xml
```

Con estos archivos respaldados, tenemos todo lo necesario para recrear la máquina virtual en el siguiente paso.

#### Tarea 2. Creación de máquina virtual a partir de copia de seguridad

En esta tarea se creará una nueva máquina virtual llamada "clon_copiando_ficheros" utilizando los archivos de copia de seguridad generados en la tarea anterior. Para ello, se emplearán las herramientas nativas de libvirt y se verificará su correcto funcionamiento.

El primer paso consiste en copiar el archivo de definición XML de la máquina virtual original, adaptándolo para la nueva máquina virtual:

```bash
root@lq-d25:~# cp /etc/libvirt/qemu/mvp1.xml /etc/libvirt/qemu/clon_copiando_ficheros.xml
```

**Explicación del comando**:

- `cp`: Herramienta estándar de Linux para copiar archivos
- `/etc/libvirt/qemu/mvp1.xml`: Archivo XML de definición de la máquina virtual original
- `/etc/libvirt/qemu/clon_copiando_ficheros.xml`: Ruta donde se creará el nuevo archivo de definición

A continuación, es necesario modificar el archivo XML copiado para adaptarlo a la nueva máquina virtual. Los cambios necesarios incluyen:

1. Cambiar el nombre de la máquina virtual
2. Generar un nuevo UUID para evitar conflictos
3. Actualizar la ruta del archivo de imagen de disco
4. Cambiar la dirección MAC de la interfaz de red

El archivo XML debe modificarse de la siguiente manera:

```xml
<!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit mvp1
or other application using the libvirt API.
-->

<domain type='kvm'>
  <name>clon_copiando_ficheros</name>
  <uuid>1f4f17c1-3037-40d4-8866-c1aa8fb37292</uuid>
  <metadata>
    <!-- ... contenido omitido ... -->
  </metadata>
  <devices>
    <emulator>/usr/bin/qemu-system-x86_64</emulator>
    <disk type='file' device='disk'>
      <driver name='qemu' type='qcow2' discard='unmap'/>
      <source file='/var/lib/libvirt/images/clon_copiando_ficheros.qcow2'/>
      <target dev='vda' bus='virtio'/>
      <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>
    </disk>
    <!-- ... contenido omitido ... -->
    <interface type='network'>
      <mac address='00:16:3e:50:87:50'/>
      <source network='default'/>
      <model type='virtio'/>
      <address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>
    </interface>
    <!-- ... contenido omitido ... -->
  </devices>
</domain>
```

**Elementos modificados en el XML**:

- `<name>`: Cambiado de "mvp1" a "clon_copiando_ficheros"
- `<uuid>`: Generado un nuevo UUID para evitar conflictos con la máquina virtual original
- `<source file>`: Actualizada la ruta del disco para apuntar al nuevo archivo de imagen
- `<mac address>`: Cambiada la dirección MAC para evitar conflictos de red

Para la generación de la nueva dirección MAC, se utiliza un script auxiliar:

```bash
root@lq-d25:~# python ./macgen.py
00:16:3e:3d:24:39
```

**Explicación del comando**:

- `python ./macgen.py`: Script que genera una dirección MAC válida
- La salida proporciona una dirección MAC única que puede utilizarse para la nueva máquina virtual

> **Nota**: Es fundamental asignar una dirección MAC única a cada máquina virtual para evitar conflictos en la red que causarían problemas de conectividad.

Una vez modificado el archivo XML, se procede a copiar el archivo de imagen de disco de la máquina virtual original:

```bash
root@lq-d25:~# cp /backup/mvp1/fedora.qcow2 /var/lib/libvirt/images/clon_copiando_ficheros.qcow2
```

**Explicación del comando**:

- `cp`: Herramienta para copiar archivos
- `/backup/mvp1/fedora.qcow2`: Archivo de imagen de disco respaldado en la tarea anterior
- `/var/lib/libvirt/images/clon_copiando_ficheros.qcow2`: Ubicación estándar donde libvirt almacena las imágenes de disco

A continuación, se establecen los permisos adecuados para el archivo de imagen de disco:

```bash
root@lq-d25:~# chown qemu:qemu /var/lib/libvirt/images/clon_copiando_ficheros.qcow2
root@lq-d25:~# chmod 600 /var/lib/libvirt/images/clon_copiando_ficheros.qcow2
```

**Explicación de los comandos**:

- `chown qemu:qemu`: Asigna el propietario y grupo "qemu" al archivo, permitiendo que el servicio QEMU/KVM acceda a él
- `chmod 600`: Establece permisos restrictivos (lectura y escritura solo para el propietario) para garantizar la seguridad

Finalmente, se define la nueva máquina virtual en libvirt utilizando el archivo XML modificado:

```bash
root@lq-d25:~# virsh define /etc/libvirt/qemu/clon_copiando_ficheros.xml
Domain 'clon_copiando_ficheros' defined from /etc/libvirt/qemu/clon_copiando_ficheros.xml
```

**Explicación del comando**:

- `virsh define`: Comando de libvirt para definir una nueva máquina virtual desde un archivo XML
- `/etc/libvirt/qemu/clon_copiando_ficheros.xml`: Ruta al archivo XML modificado
- La salida confirma que la definición se ha completado correctamente

Para verificar que la máquina virtual se ha definido correctamente, se ejecuta:

```bash
root@lq-d25:~# virsh list --all
Id   Nombre                   Estado
----------------------------------------
-    clon_copiando_ficheros   apagado
-    mvp1                     apagado
```

**Explicación del comando**:

- `virsh list --all`: Muestra todas las máquinas virtuales definidas, tanto en ejecución como apagadas
- La salida muestra que la nueva máquina virtual "clon_copiando_ficheros" está definida correctamente en estado apagado

Para iniciar la máquina virtual clonada y verificar su funcionalidad:

```bash
root@lq-d25:~# virsh start clon_copiando_ficheros
Domain 'clon_copiando_ficheros' started
```

**Explicación del comando**:

- `virsh start`: Comando para iniciar una máquina virtual definida
- `clon_copiando_ficheros`: Nombre de la máquina virtual a iniciar
- La salida confirma que la máquina virtual se ha iniciado correctamente

Una vez iniciada, se puede verificar su estado:

```bash
root@lq-d25:~# virsh list
 Id   Nombre                   Estado
------------------------------------------
 3    clon_copiando_ficheros   ejecutando
```

La máquina virtual clonada está ahora en ejecución y lista para ser utilizada, completando así el proceso de creación de una máquina virtual a partir de una copia de seguridad manual.

### Fase 2. Clonación de máquinas virtuales

#### Tarea 3. Clonación mediante virt-manager

En esta tarea se realizará la clonación de la máquina virtual mvp1 utilizando la interfaz gráfica virt-manager. La nueva máquina virtual se llamará "clon_virt_manager" y deberá verificarse su correcto funcionamiento y conectividad.

#### Tarea 4. Clonación mediante virt-clone

En esta tarea se realizará la clonación de la máquina virtual mvp1 utilizando la herramienta de línea de comandos virt-clone. La nueva máquina virtual se llamará "clon_virt_clone" y deberá verificarse su correcto funcionamiento y conectividad.

### Fase 3. Creación de máquinas virtuales con virt-install

#### Tarea 5. Creación e instalación de máquina virtual con virt-install

En esta tarea se creará una nueva máquina virtual llamada "Creacion_virt_install" utilizando la herramienta de línea de comandos virt-install. La máquina virtual tendrá las siguientes especificaciones:

- RAM: 2 GB
- CPU: 1
- Disco: 10 GB
- Sistema Operativo: Fedora Server 41 (instalación mínima)
- Red: NAT

## Pruebas y Validación

### Verificación de máquinas virtuales clonadas

### Verificación de conectividad

### Verificación de acceso SSH

## Solución de Problemas Comunes

### Problemas con la clonación de máquinas virtuales

### Problemas de conectividad

### Problemas con virt-install

## Conclusiones

## Bibliografía

1. Herrmann J, Zimmerman Y, Parker D, Novich L, East J, Radvan S. Red Hat Enterprise Linux 7. Virtualization Getting Started Guide. Introduction to virtualization technologies available with RHEL, Red Hat; 2019. Disponible en: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/ [accedido el 02/01/2024]

2. Herrmann J, Zimmerman Y, Novich L, Parker D, Radvan S, Richardson T. Red Hat Enterprise Linux 7. Virtualization Deployment and Administration Guide. Installing, configuring, and managing virtual machines on a RHEL physical machine, Red Hat; 2019. Disponible en: https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/ [accedido el 02/01/2024]

3. Documentación de Fedora sobre virtualización: [https://docs.fedoraproject.org/en-US/quick-docs/virtualization-getting-started/](https://docs.fedoraproject.org/en-US/quick-docs/virtualization-getting-started/)

4. Libvirt Wiki: [https://wiki.libvirt.org/](https://wiki.libvirt.org/)
